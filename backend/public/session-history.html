<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Session History</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .session-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .session-table th,
        .session-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .session-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .active-session {
            background-color: #d4edda;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls input,
        .controls select,
        .controls button {
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .controls button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #0056b3;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }
        .pagination button:hover {
            background: #f8f9fa;
        }
        .pagination button.active {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 Player Session History</h1>
        
        <!-- Statistics -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">-</div>
                <div>Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeSessions">-</div>
                <div>Active Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniquePlayers">-</div>
                <div>Unique Players</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgSessionTime">-</div>
                <div>Avg Session Time</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <input type="text" id="playerFilter" placeholder="Filter by player name...">
            <select id="timeFilter">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
            </select>
            <label>
                <input type="checkbox" id="activeOnly"> Active only
            </label>
            <button onclick="loadSessions()">Refresh</button>
            <button onclick="testAPI()" style="background-color: #28a745;">Test API</button>
            <button onclick="startTestSession()" style="background-color: #ffc107; color: black;">Start Test Session</button>
            <button onclick="endTestSession()" style="background-color: #dc3545;">End Test Session</button>
        </div>

        <!-- Status indicator -->
        <div id="statusIndicator" style="margin-bottom: 15px; padding: 10px; border-radius: 4px; display: none;">
            <strong>Status:</strong> <span id="statusText"></span>
        </div>

        <!-- Sessions Table -->
        <table class="session-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Session Start</th>
                    <th>Session End</th>
                    <th>Duration</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="sessionsTable">
                <tr>
                    <td colspan="5" style="text-align: center;">Loading...</td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentPage = 1;
        let totalPages = 1;

        // Format duration from seconds to human readable
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // Format date to readable string
        function formatDate(dateString) {
            if (!dateString) return 'Active';
            return new Date(dateString).toLocaleString();
        }

        // Load session statistics
        async function loadStats() {
            try {
                showStatus('Loading statistics...', 'info');
                const timeFilter = document.getElementById('timeFilter').value;
                const response = await fetch(`${API_BASE}/sessions/stats?days=${timeFilter}`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data.stats;
                    document.getElementById('totalSessions').textContent = stats.totalSessions;
                    document.getElementById('uniquePlayers').textContent = stats.uniquePlayers;
                    document.getElementById('avgSessionTime').textContent = formatDuration(stats.averageSessionLength);
                    showStatus('Statistics loaded successfully', 'success');
                } else {
                    showStatus('Failed to load statistics: ' + data.error, 'error');
                }

                // Load active sessions count
                const activeResponse = await fetch(`${API_BASE}/sessions/active`);
                const activeData = await activeResponse.json();
                if (activeData.success) {
                    document.getElementById('activeSessions').textContent = activeData.data.count;
                } else {
                    showStatus('Failed to load active sessions: ' + activeData.error, 'error');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showStatus('Error loading statistics: ' + error.message, 'error');
            }
        }

        // Load sessions with current filters
        async function loadSessions(page = 1) {
            try {
                showStatus('Loading sessions...', 'info');
                const playerFilter = document.getElementById('playerFilter').value;
                const activeOnly = document.getElementById('activeOnly').checked;
                
                let url = `${API_BASE}/sessions?page=${page}&limit=20`;
                if (playerFilter) url += `&playerName=${encodeURIComponent(playerFilter)}`;
                if (activeOnly) url += `&activeOnly=true`;

                console.log('Fetching URL:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success) {
                    displaySessions(data.data.sessions);
                    updatePagination(data.data.pagination);
                    showStatus(`Loaded ${data.data.sessions.length} sessions`, 'success');
                } else {
                    showStatus('Failed to load sessions: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showStatus('Error loading sessions: ' + error.message, 'error');
                document.getElementById('sessionsTable').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: red;">Error loading sessions</td></tr>';
            }
        }

        // Display sessions in table
        function displaySessions(sessions) {
            const tbody = document.getElementById('sessionsTable');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No sessions found</td></tr>';
                return;
            }

            tbody.innerHTML = sessions.map(session => `
                <tr class="${session.isActive ? 'active-session' : ''}">
                    <td>${session.playerName}</td>
                    <td>${formatDate(session.sessionStart)}</td>
                    <td>${formatDate(session.sessionEnd)}</td>
                    <td>${formatDuration(session.duration)}</td>
                    <td>${session.isActive ? '🟢 Active' : '⚫ Ended'}</td>
                </tr>
            `).join('');
        }

        // Update pagination controls
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.totalPages;
            
            const paginationDiv = document.getElementById('pagination');
            let html = '';
            
            // Previous button
            if (currentPage > 1) {
                html += `<button onclick="loadSessions(${currentPage - 1})">← Previous</button>`;
            }
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadSessions(${i})">${i}</button>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                html += `<button onclick="loadSessions(${currentPage + 1})">Next →</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (document.getElementById('activeOnly').checked) {
                loadSessions(currentPage);
            }
            loadStats();
        }, 30000);

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadSessions();
            
            // Add event listeners for filters
            document.getElementById('timeFilter').addEventListener('change', loadStats);
            document.getElementById('playerFilter').addEventListener('input', 
                debounce(() => loadSessions(1), 500));
        });

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show status messages
        function showStatus(message, type = 'info') {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            text.textContent = message;
            indicator.style.display = 'block';
            
            // Color based on type
            switch (type) {
                case 'success':
                    indicator.style.backgroundColor = '#d4edda';
                    indicator.style.color = '#155724';
                    indicator.style.borderColor = '#c3e6cb';
                    break;
                case 'error':
                    indicator.style.backgroundColor = '#f8d7da';
                    indicator.style.color = '#721c24';
                    indicator.style.borderColor = '#f5c6cb';
                    break;
                case 'info':
                default:
                    indicator.style.backgroundColor = '#d1ecf1';
                    indicator.style.color = '#0c5460';
                    indicator.style.borderColor = '#bee5eb';
                    break;
            }
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
        }

        // Test API connectivity
        async function testAPI() {
            try {
                showStatus('Testing API connection...', 'info');
                
                // Test all endpoints
                const tests = [
                    { name: 'Sessions', url: `${API_BASE}/sessions?limit=1` },
                    { name: 'Stats', url: `${API_BASE}/sessions/stats?days=7` },
                    { name: 'Active Sessions', url: `${API_BASE}/sessions/active` }
                ];
                
                const results = [];
                
                for (const test of tests) {
                    try {
                        const response = await fetch(test.url);
                        const data = await response.json();
                        results.push(`✅ ${test.name}: ${data.success ? 'OK' : 'Failed'}`);
                    } catch (error) {
                        results.push(`❌ ${test.name}: ${error.message}`);
                    }
                }
                
                showStatus('API Test Results: ' + results.join(' | '), 'info');
                console.log('API Test Results:', results);
                
            } catch (error) {
                showStatus('API test failed: ' + error.message, 'error');
            }
        }

        // Start a test session
        async function startTestSession() {
            try {
                const playerName = prompt('Enter test player name:', 'TestPlayer' + Date.now());
                if (!playerName) return;
                
                showStatus(`Starting test session for ${playerName}...`, 'info');
                
                const response = await fetch(`${API_BASE}/sessions/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`✅ Test session started for ${playerName}`, 'success');
                    loadSessions(currentPage);
                    loadStats();
                } else {
                    showStatus(`Failed to start session: ${data.error}`, 'error');
                }
                
            } catch (error) {
                showStatus('Error starting test session: ' + error.message, 'error');
            }
        }

        // End a test session
        async function endTestSession() {
            try {
                const playerName = prompt('Enter player name to end session:', 'TestPlayer');
                if (!playerName) return;
                
                showStatus(`Ending test session for ${playerName}...`, 'info');
                
                const response = await fetch(`${API_BASE}/sessions/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`✅ Test session ended for ${playerName}`, 'success');
                    loadSessions(currentPage);
                    loadStats();
                } else {
                    showStatus(`Failed to end session: ${data.error}`, 'error');
                }
                
            } catch (error) {
                showStatus('Error ending test session: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>